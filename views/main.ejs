<%- include("top.ejs") %>
<head>
    <title>מסך עובדים</title>
</head>

<body>

<div id="AddForm">
    <form id="employeeForm">
        <input type="text" name="name" id="name" placeholder="שם" />
        <input type="text" name="id" id="id" placeholder="מספר זיהוי" />
        <button type="button" onclick="addNewRow();">הוסף שורה</button>
    </form>
    <button onclick="clockIn();">כניסה</button>
    <button onclick="clockOut();">יציאה</button>
</div>

<hr />
<table>
    <thead>
    <tr>
        <th>שם</th>
        <th>מספר זיהוי</th>
        <th>תאריך</th>
        <th>כניסה</th>
        <th>יציאה</th>
        <th>פעולות</th>
    </tr>
    </thead>
    <tbody id="mainTable"></tbody>
</table>

<script>
    let raw_data = [];
    let currentEditIndex = -1; // עריכה נוכחית, מתחילה ממספר שאינו תקין

    function CreateTable() {
        let str = "";
        for (let i = 0; i < raw_data.length; i++) {
            str += "<tr>";
            str += "<td>" + raw_data[i].name + "</td>";
            str += "<td>" + raw_data[i].id + "</td>";
            str += "<td>" + raw_data[i].date + "</td>";
            str += "<td id='clockInTime_" + i + "'>" + raw_data[i].clockIn + "</td>";
            str += "<td id='clockOutTime_" + i + "'>" + raw_data[i].clockOut + "</td>";
            str += "<td><button onclick='editRow(" + i + ");'>ערוך</button><button onclick='deleteRow(" + i + ");'>מחק</button></td>";
            str += "</tr>";
        }
        document.getElementById("mainTable").innerHTML = str;
    }

    function clearForm() {
        document.getElementById("name").value = "";
        document.getElementById("id").value = "";
    }

    function enableEditMode(index) {
        currentEditIndex = index;
        document.getElementById("name").value = raw_data[index].name;
        document.getElementById("id").value = raw_data[index].id;
    }

    async function addNewRow() {
        let name = document.getElementById("name").value;
        let id = document.getElementById("id").value;

        if (name.trim() !== "" && id.trim() !== "") {
            let date = new Date().toLocaleDateString();
            raw_data.push({
                name: name,
                id: id,
                date: date,
                clockIn: "",
                clockOut: ""
            });
            CreateTable();
            clearForm();
        }
    }

    async function deleteRow(index) {
        raw_data.splice(index, 1);
        CreateTable();
    }

    async function editRow(index) {
        enableEditMode(index);
    }

    async function clockIn() {
        let name = document.getElementById("name").value;
        let id = document.getElementById("id").value;

        if (name.trim() !== "" && id.trim() !== "") {
            // שלח בקשת POST לשרת עם המידע הנדרש
            fetch('/clockIn', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    id: id,
                })
            }).then(response => response.json()).then(data => {
                // כאן אתה מקבל את התאריך והשעה המדויקים מהשרת ותוכל לעדכן את השורה הרלוונטית בטבלה
                let lastIndex = raw_data.length - 1;
                raw_data[lastIndex].date = data.date;
                raw_data[lastIndex].clockIn = data.exactTime;
                // עדכן את השעת כניסה בתא המתאים בטבלה
                document.getElementById("clockInTime_" + lastIndex).innerText = data.exactTime;
                CreateTable();
                clearForm();
            }).catch(error => {
                console.error(error);
            });
        }
    }

    async function clockOut() {
        let name = document.getElementById("name").value;
        let id = document.getElementById("id").value;

        if (name.trim() !== "" && id.trim() !== "") {
            // שלח בקשת POST לשרת עם המידע הנדרש
            fetch('/clockOut', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    id: id,
                })
            }).then(response => response.json()).then(data => {
                // כאן אתה מקבל את התאריך והשעה המדויקים מהשרת ותוכל לעדכן את השורה הרלוונטית בטבלה
                let lastIndex = raw_data.length - 1;
                raw_data[lastIndex].clockOut = data.exactTime;
                // עדכן את השעת יציאה בתא המתאים בטבלה
                document.getElementById("clockOutTime_" + lastIndex).innerText = data.exactTime;
                CreateTable();
                clearForm();
            }).catch(error => {
                console.error(error);
            });
        }
    }
</script>
<%- include("bottom.ejs") %>
