<%- include("top.ejs") %>
<title>מסך עובדים</title>

<body>

<div id="AddForm">
    <form id="employeeForm">
        <input type="text" name="name" id="name" placeholder="שם" />
        <input type="text" name="id" id="id" placeholder="מספר זיהוי" />
        <button type="button" onclick="addNewRow();">הוסף שורה</button>
    </form>
    <button onclick="clockIn();">כניסה</button>
    <button onclick="clockOut();">יציאה</button>
</div>

<hr>
<button onclick="deleteRow();">מחק שורה</button>
<hr/>
<button onclick="editRow();">ערוך שורה</button>
<hr/>

<table>
    <thead>
    <tr>
        <th>שם</th>
        <th>מספר זיהוי</th>
        <th>תאריך</th>
        <th>כניסה</th>
        <th>יציאה</th>
        <th>פעולות</th>
    </tr>
    </thead>
    <tbody id="mainTable">  </tbody>
</table>

<!-- שדה עבור השעה הנכונה של היציאה -->
<input type="text" id="exitTime" readonly>

<script>
    let raw_data=[];
    let currentEditIndex = -1; // עריכה נוכחית, מתחילה ממספר שאינו תקין

    function CreateTable(){
        let str="";
        for(let i = 0; i < raw_data.length; i++) {
            str+="<tr>";
            str+="<td>"+raw_data[i].name+"</td>";
            str+="<td>"+raw_data[i].id+"</td>";
            str+="<td>"+raw_data[i].date+"</td>";
            str+="<td id='clockInTime_"+i+"'>"+raw_data[i].clockIn+"</td>";
            str+="<td id='clockOutTime_"+i+"'>"+raw_data[i].clockOut+"</td>";
            str+="<td><button onclick='deleteRow("+i+");'>מחק</button></td>";
            str+="</tr>";
        }
        document.getElementById("mainTable").innerHTML=str;
    }

    function clearForm() {
        document.getElementById("name").value = "";
        document.getElementById("id").value = "";
    }

    function enableEditMode(index) {
        currentEditIndex = index;
        document.getElementById("name").value = raw_data[index].name;
        document.getElementById("id").value = raw_data[index].id;
    }

    async function getList() {
        let response = await fetch('/List');
        let data = await response.json();
        raw_data = data;
        CreateTable();
    }

    async function addNewRow() {
        let name=document.getElementById("name").value;
        let id=document.getElementById("id").value;

        if (name.trim() !== "" && id.trim() !== "") {
            let date = new Date().toLocaleDateString();
            let currentTime = new Date().toLocaleTimeString();
            raw_data.push({
                name: name,
                id: id,
                date: date,
                clockIn: currentTime,
                clockOut: ""
            });
            CreateTable();
            clearForm();
        }
    }

    async function deleteRow() {
        if (currentEditIndex !== -1) {
            raw_data.splice(currentEditIndex, 1);
            currentEditIndex = -1;
            clearForm();
            CreateTable();
        }
    }

    async function editRow() {
        if (currentEditIndex !== -1) {
            let name=document.getElementById("name").value;
            let id=document.getElementById("id").value;

            if (name.trim() !== "" && id.trim() !== "") {
                raw_data[currentEditIndex].name = name;
                raw_data[currentEditIndex].id = id;
                CreateTable();
                clearForm();
                currentEditIndex = -1;
            }
        }
    }

    async function clockIn() {
        let name = document.getElementById("name").value;
        let id = document.getElementById("id").value;

        if (name.trim() !== "" && id.trim() !== "") {
            let date = new Date().toLocaleDateString();
            let currentTime = new Date().toLocaleTimeString();

            // שלח בקשת POST לשרת עם המידע הנדרש
            fetch('/clockIn', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    id: id,
                    date: date,
                    currentTime: currentTime
                })
            }).then(response => response.json()).then(data => {
                // כאן אתה מקבל את התאריך המדויק מהשרת ותוכל לעדכן את השורה הרלוונטית בטבלה
                // דוגמא: document.getElementById("clockInTime_" + rowIdx).textContent = data.exactTime;
            }).catch(error => {
                console.error(error);
            });
        }
    }

    async function clockOut() {
        let name = document.getElementById("name").value;
        let id = document.getElementById("id").value;

        if (name.trim() !== "" && id.trim() !== "") {
            let date = new Date().toLocaleDateString();
            let currentTime = new Date().toLocaleTimeString();

            // שלח בקשת POST לשרת עם המידע הנדרש
            fetch('/clockOut', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    id: id,
                    date: date,
                    currentTime: currentTime
                })
            }).then(response => response.json()).then(data => {
                // כאן אתה מקבל את התאריך המדויק מהשרת ותוכל לעדכן את השורה הרלוונטית בטבלה
                // דוגמא: document.getElementById("clockOutTime_" + rowIdx).textContent = data.exactTime;
            }).catch(error => {
                console.error(error);
            });
        }
    }

    getList();
</script>
<%- include("bottom.ejs") %>
</body>
</html>
